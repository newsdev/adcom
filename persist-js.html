<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Persist.js &middot; Adcom
    
  </title>

  <meta name="description" content="Adcom is a set of JavaScript plugins and frontend style that are the foundation for admin sites at The New York Times.">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:url" content="https://newsdev.github.io/adcom/">
  <meta name="twitter:title" content="Adcom (Admin Components)">
  <meta name="twitter:description" content="Adcom is a set of JavaScript plugins and frontend style that are the foundation for admin sites at The New York Times.">
  <meta name="twitter:image" content="/adcom/public/images/twittercard.png">
  <meta name="og:image" content="/adcom/public/images/facebookshare.png">
  <meta name="og:site_name" content="Adcom (Admin Components)">
  <meta name="og:url" content="https://newsdev.github.io/adcom/">

  <meta name="canonical" content="https://newsdev.github.io/adcom/">

  <!-- CSS -->
  <link rel="stylesheet" href="/adcom/public/css/poole.css">
  <link rel="stylesheet" href="/adcom/public/css/syntax.css">
  <link rel="stylesheet" href="/adcom/public/css/lanyon.css">
  <link rel="stylesheet" href="/adcom/public/css/adcom-namespaced.css">
  <link rel="stylesheet" href="/adcom/public/css/adcom-docs.css">
  <link rel="stylesheet" href="/adcom/public/css/prism.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/adcom/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/adcom/public/favicon.ico">

  <script type="text/javascript" src="http://typeface.nytimes.com/zam5nzz.js"></script>
  <script type="text/javascript">try{Typekit.load();}catch(e){}</script>
</head>


  <body class="">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p><strong>Ad</strong>min <strong>com</strong>ponents</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item " href="/adcom/">Home</a>
    <hr>
    <a class="sidebar-nav-item " href="/adcom/list-js.html">List.js</a>
    <a class="sidebar-nav-item " href="/adcom/form-js.html">Form.js</a>
    <a class="sidebar-nav-item " href="/adcom/session-js.html">Session.js</a>
    <a class="sidebar-nav-item active" href="/adcom/persist-js.html">Persist.js</a>
    <a class="sidebar-nav-item " href="/adcom/message-js.html">Message.js</a>
    <hr>
    <a class="sidebar-nav-item " href="/adcom/styles.html">Styles</a>
    <a class="sidebar-nav-item" href="/adcom/boilerplate.html">Boilerplate</a>
    <hr>

    <a class="sidebar-nav-item" href="https://github.com/newsdev/adcom/archive/v0.1.0.zip">Download</a>
    <a class="sidebar-nav-item" href="https://github.com/newsdev/adcom">GitHub project</a>
    <span class="sidebar-nav-item">Currently v0.1.0</span>
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2015 The New York Times Company.
    </p>
  </div>

  <div class="sidebar-item sidebar-img">
    <img src="/adcom/public/images/logo.png">
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/adcom/" title="Home">Adcom</a>
          </h3>
        </div>
      </div>

      <div class="container content">
        <h2 id="what-is-persist.js?">What is Persist.js?</h2>

<blockquote>
<p>Persist.js saves changes to page elements to persist them across page loads.</p>
</blockquote>

<hr>

<ul>
<li><a href="/adcom/#javascript-usage">Usage</a></li>
<li><a href="#examples">Examples</a></li>
<li><a href="#options">Options</a></li>
<li><a href="#api">API</a></li>
<li><a href="#events">Events</a></li>
</ul>

<hr>

<p>Persist.js is a wrapper around the <a href="https://developer.mozilla.org/en-US/docs/Web/API/MutationObserver">MutationObserver API</a>, which triggers updates when an element&#39;s attributes, text data or subtree changes.</p>

<p>With it, when certain changes happen on the page, those changes can be persisted and reapplied the next time a user visits.</p>

<p>The changes you can save are:</p>

<ul>
<li>An element&#39;s attribute value (such as it&#39;s <code>class</code>)</li>
<li>The value of any text nodes within an element</li>
</ul>

<hr>

<h2 id="examples">Examples</h2>

<p>Out of the box, Persist.js doesn&#39;t actually save your page state anywhere. Instead, it fires two events that you should listen for, and save the data into your own backend of choice. These examples use Session.js, and you can see that particular integration <a href="#integrate-with-session.js%22">here</a>.</p>

<h3 id="attributes">Attributes</h3>

<p>Persist.js was created to persist the state of page elements across page loads for users (e.g., whether or not a navigation bar is expanded). Since state is often controlled by the presence of one or more CSS classes, we decided to persist that directly.</p>

<p>This example tells the plugin to save any changes to the <code>class</code> attribute on the button. When it runs, Persist.js will also check whether a saved setting for that attribute exists in storage; if it does, it sets the attribute, &quot;restoring&quot; it to its last known state.</p>

<p>Try <strong>clicking the button</strong> to toggle the <code>active</code> class and <strong>refreshing the page</strong> to see it persist.</p>
<div class="highlight"><pre><code class="language-example-html-bs" data-lang="example-html-bs">&lt;button id="1" type="button" data-toggle="button"
  class="btn btn-primary"&gt;Button&lt;/button&gt;

&lt;script type="text/javascript"&gt;
  $('#1').persist('attribute', 'class');
&lt;/script&gt;
</code></pre></div>
<p>Because the value of the attribute is replaced, you may notice that adding classes to the button&#39;s source markup after state has been persisted once will do nothing. The original persisted classes will replace the ones baked into the marked on initialization. That means you can&#39;t do something like change the button&#39;s color.</p>

<p>So attribute persistence takes an optional third argument, a <strong>filter</strong>, that lets you specify one or more classes to restrict persistence to. Setting the filter to <code>active</code> means that <code>btn</code> and <code>btn-primary</code> will not be saved, and classes other than <code>active</code> will not be removed on page load.</p>

<p>You can add / remove button colors at any point in this example:</p>
<div class="highlight"><pre><code class="language-example-html-bs" data-lang="example-html-bs">&lt;button id="2" type="button" data-toggle="button"
  class="btn btn-primary"&gt;Button&lt;/button&gt;

&lt;script type="text/javascript"&gt;
  $('#2').persist('attribute', 'class', 'active');
&lt;/script&gt;
</code></pre></div>
<h3 id="character-data">Character Data</h3>

<p><strong>This feature isn&#39;t officially supported, but is included to explore how the other types of data in MutationObserver could be persisted. The third type, <code>ChildList</code> currently isn&#39;t supported at all.</strong></p>

<p>Certain nodes in HTML are &quot;Text Nodes&quot; which contain... text. A <code>p</code> tag, for example, could contain multiple text nodes separated with <code>&lt;br&gt;</code>s. Each has a <code>data</code> attribute containing the text, which MutationObserver described as <code>characterData</code>.</p>

<p>While text nodes are not directly addressable via jQuery, you can turn persistence for characterData on for all text nodes within an element.</p>
<div class="highlight"><pre><code class="language-example-html-bs" data-lang="example-html-bs">&lt;p id="3" contentEditable&gt;
  You can edit this text, and it will persist across page loads.
&lt;/p&gt;

&lt;script type="text/javascript"&gt;
  $('#3').persist('characterData');
&lt;/script&gt;
</code></pre></div>
<p>This method should be considered very fragile at the moment.</p>

<h3 id="wire-up-to-a-backend">Wire up to a backend</h3>

<p>There are two events to listen for in order to communicate with your backend of choice.</p>

<p><code>mutation.ac.persist</code> fires when MutationObserver has detected a relevant change. The <code>key</code> attributes defines a hash that uniquely identifies the target of the change:</p>

<ul>
<li><strong>element</strong> - the <code>id</code> of the watched element, or the value of it&#39;s <code>data-key</code> attribute</li>
<li><strong>type</strong> - <code>attributes</code> or <code>characterData</code></li>
<li><strong>path</strong> - the attribute that has changed, such as <code>class</code></li>
</ul>

<p>You should serialize this into a unique key, and store the event&#39;s <code>value</code> there.</p>

<p><code>added.ac.persist</code> fires when Persist.js starts to listen for changes, and is the cue to restore any existing state data.</p>

<p>This event also provides a <code>key</code> hash, which you can again use to construct a key for your data store. If an existing value is present, then you should call <code>.persist(&quot;update&quot;)</code> on the element to set the change, also passing it <code>e.key</code> and the value retrieved from the storage backend.</p>

<p>View a complete example below, used for integrating with Session.js</p>

<h3 id="integration-with-session.js">Integration with Session.js</h3>

<p>This example integration uses Session.js to save changes tracked by Persist.js.</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">mutationSession</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Session</span><span class="p">({</span><span class="na">key</span><span class="p">:</span> <span class="s1">'adcomDocs'</span><span class="p">});</span>

<span class="c1">// Fired when a change occurs</span>
<span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">'mutation.ac.persist'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">storageKey</span> <span class="o">=</span> <span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">element</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">path</span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">'.'</span><span class="p">);</span>

  <span class="c1">// e.mutation is a MutationRecord</span>
  <span class="nx">mutationSession</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">storageKey</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// Fired on Persist.js initialization</span>
<span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">'added.ac.persist'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">storageKey</span> <span class="o">=</span> <span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">element</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">path</span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">'.'</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">mutationSession</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">storageKey</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">persist</span><span class="p">(</span><span class="s1">'update'</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
<p>The above example is set up to handle attribute changes; tracking characterData changes requires this code for the <code>added.ac.persist</code> event:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">'added.ac.persist'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">prefix</span> <span class="o">=</span> <span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">element</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">path</span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">'.'</span><span class="p">)</span>
  <span class="kd">var</span> <span class="nx">matches</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">grep</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">mutationSession</span><span class="p">.</span><span class="nx">data</span><span class="p">),</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">k</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">prefix</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">})</span>

  <span class="c1">// For attribute changes, matches will just be the key for the attribute.</span>
  <span class="c1">// For characterData, multiple keys might match.</span>
  <span class="nx">matches</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">match</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">({},</span> <span class="nx">e</span><span class="p">.</span><span class="nx">key</span><span class="p">)</span>
    <span class="c1">// add on the path to individual text nodes for characterData</span>
    <span class="nx">key</span><span class="p">.</span><span class="nx">path</span> <span class="o">=</span> <span class="nx">key</span><span class="p">.</span><span class="nx">path</span> <span class="o">||</span> <span class="nx">match</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">'.'</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">'.'</span><span class="p">)</span>

    <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">mutationSession</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">match</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">persist</span><span class="p">(</span><span class="s1">'update'</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>
  <span class="p">})</span>
<span class="p">});</span>
</code></pre></div>
<hr>

<h2 id="options">Options</h2>

<p><a href="/adcom/#plugin-initialization">A note</a> on using data attributes versus initializer functions.</p>

<p>Data attribute options can be set either on the message element, or on the trigger element. Options on the trigger element will take precedence, just as options passed to the JavaScript initializer will take precedence over data attribute settings on the message element.</p>

<table><thead>
<tr>
<th>attribute</th>
<th>type</th>
<th>default</th>
<th>description</th>
</tr>
</thead><tbody>
<tr>
<td>key</td>
<td>string</td>
<td>value of element&#39;s <code>id</code></td>
<td>Base key used to track any changes on this element.</td>
</tr>
</tbody></table>

<hr>

<h2 id="api">API <small>Public methods</small></h2>

<table><thead>
<tr>
<th>method</th>
<th>description</th>
</tr>
</thead><tbody>
<tr>
<td>.persist(&#39;attributes&#39;, String/Array[, String/Array])</td>
<td>Pass an array or space-delimited list of attributes to detect changes on. Optional third argument is an array or space-delimited filter list. If present, then only those values will be included in the mutation event&#39;s <code>value</code> attribute.</td>
</tr>
<tr>
<td>.persist(&#39;characterData&#39;)</td>
<td>Detect changes on all text nodes underneath the specified parent element.</td>
</tr>
</tbody></table>

<h2 id=""></h2>

<h2 id="events">Events</h2>

<p>All events with a pre and post version (such as <code>show</code> and <code>shown</code>) can be cancelled by calling <code>.preventDefault()</code> on the pre event.</p>

<p>Each event has a <code>key</code> attribute available that defines <code>element</code>, <code>type</code> and <code>path</code>, which together identify the change target.</p>

<table><thead>
<tr>
<th>event</th>
<th>trigger</th>
<th>event properties</th>
</tr>
</thead><tbody>
<tr>
<td>add.ac.persist</td>
<td>Immediately when <code>.persist()</code> is called on an element.</td>
<td><code>key</code></td>
</tr>
<tr>
<td>added.ac.persist</td>
<td>After an element has been configured to watch for changes, and after existing persisted changes have been set on it.</td>
<td><code>key</code></td>
</tr>
<tr>
<td>mutation.ac.persist</td>
<td>After a mutation has occurred.</td>
<td><code>key</code> <br> <code>mutation</code> MutationRecord <br> <code>value</code> value of the changed attribute or new characterData</td>
</tr>
</tbody></table>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');
        document.addEventListener('click', function(e) {
          var target = e.target;
          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;
          checkbox.checked = false;
        }, false);
      })(document);
    </script>
    <script type="text/javascript" src="/adcom/public/js/jquery.min.js"></script>
    <script type="text/javascript" src="/adcom/public/js/underscore-min.js"></script>
    <script type="text/javascript" src="/adcom/public/js/bootstrap.js"></script>
    <script type="text/javascript" src="/adcom/public/js/prism.js" data-manual></script>
    <script type="text/javascript" src="/adcom/public/js/beautify-html.js" data-manual></script>
    <script type="text/javascript" src="/adcom/public/js/adcom.js"></script>
    <script type="text/javascript" src="/adcom/public/js/adcom-docs.js"></script>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-60337978-2', 'auto');
      ga('send', 'pageview');
  </script>
  </body>
</html>
